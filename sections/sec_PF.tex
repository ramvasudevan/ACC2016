\section{Problem Formulation}
\label{sec:prob}

In this section, we present a pair of dual infinite dimensional linear programs that compute the uncertain backwards reachable set. 
Critically, note that despite the uncertainty being drawn from a distribution at the arrival into each mode, it remains constant throughout that mode. 
As a result, this unknown parameter can be appended to the dynamics of every mode $j$ and treated as a portion of the state-space:
\begin{align}
f_j=\begin{bmatrix}
  \tilde f_j'&\mathbf{0}'_{n_{\theta_j}}
\end{bmatrix}'.
\end{align}
%In this augmented-state-space---henceforth referred to as the state-space of the system---the object of interest still remains the same, $X_{(0,j)},\,\forall j\in \mathcal J$. Furthermore, as the system transitions out of a mode, say at time $\tau_k$ the solution reaches $e_{ij}$, the uncertainty in mode $j$ is not related to the \emph{actual} value of the uncertainty in mode $i$ at $\tau_k$; in fact, the dimensions of the uncertain parameters $n_{\theta_j}$ need not equal $n_{\theta_i}$, much less their distributions.

To address this problem, we rely on the notion of occupation measures, first introduced in \cite{Pitman1977}, to transform the hybrid nonlinear dynamics of the system into a set linear dynamics over measures that can more readily be solved.
Occupation measures can be interested as measuring the time a solution spends in a portion of the state-space. 
For instance, suppose the system enters mode $j$ at $\tau_k$ with the states being initialized as $x(\tau_k)=x_0$ and $\theta(\tau_k)=\theta$.
The occupation measure, \mbox{$\mu_j(\cdot\mid \tau_k,x_0,\,\theta)\in \mathcal M_+(\mathcal T\times D_j\times \Theta_j)$}, is defined as:
\small
\begin{align}
\hspace*{-1mm}\mu_j(A\times B\times C| \tau_k ,x_0,\theta)=\hspace*{-1.25mm}\int\limits_{\cal T} \hspace*{-1.25mm} I_{A\times B\times C}(t,x(t|\tau_k,x_0,\theta),\theta)dt.
\end{align}
\normalsize
Note the follow relation between the Lebesgue measure on $\mathcal T$ and $\mu_j(\cdot\mid \tau_k,x_0,\theta)$ holds for all $v \in C(\mathcal T\times D_j\times \Theta_j)$:
\begin{align}
\ip{\mu_j(\cdot\mid \tau_k,x_0,\theta),v}=\ip{\lambda_t,v(t,x(t\mid \tau_k,x_0,\theta),\theta)},
\label{eq:mu_lambda}
\end{align}
The occupational measure as defined is a conditional measure -- conditioned on the arrival-time and initial values of the states in that mode.
To consider a set of possible arrival-times and initial conditions, we define the \emph{average occupation measure} by integrating the conditional occupation measure against a measure on the set of possible initial conditions of the mode, $\mu_{s_j} \in  {\cal M}_+(\mathcal T\times D_j\times \Theta_j)$:
\begin{align}
\mu_j(A\times B\times C)= \hspace*{-5mm}\int\limits_{\mathcal T\times D_j\times \Theta}\hspace*{-5mm}\mu_j(A\times B\times C\mid \tau_k,x_0,\theta)\,d \mu_{s_j}.
\label{eq:mu_avg}
\end{align}
Observe that by definition, the uncertain variables are independent of the states' initial conditions; hence $\mu_{s_i}\in \mathcal M_+(\mathcal T\times D_j\times \Theta)$ is expressible as a product measure:
\begin{align}
\mu_{s_j}=\bar\mu_{0_j}\otimes \mu_{\theta_j},\
\end{align}
where $\bar \mu_{0_j}\in \mathcal M_+(\mathcal T\times D_j)$ is a measure describing the set of initial conditions, and $\mu_{\theta_j}\in \mathcal M_+(\Theta_j)$ is as in the definition of $\mathcal H$.

Similarly, measures on terminals sets, $\mu_{T_j}\in \mathcal M_+(X_{(T,j)}\times \Theta_j)$:
\begin{align}
\mu_{T_j}(A\times B)= \hspace*{-4mm}\int\limits_{\mathcal T\times X_{(T,j)}\times \Theta}\hspace*{-4mm}I_{A\times B}(x(T\mid \tau_k,x_0,\theta),\theta)\,d\mu_{s_{j}},
\end{align}
and guards, $\mu_{ G_{e}}\in \mathcal M_+(\mathcal T\times  G_{(j,k)})$:
\begin{align}
\mu_{G_{(j,k)}}(A\times B\times C)=\hspace*{-5mm}\int\limits_{\mathcal T\times G_{(j,k)}}\hspace*{-5mm}I_{A\times B\times C}(t,x(t\mid \tau_k,x_0,\theta),\theta)\,d\mu_{s_{j}}
\end{align}
for all $(j,k) \in {\cal E}$ can be defined. 
The measures $\mu_{ G_{(j,k)}}$ are supported on the guards of mode $j$ and should be interpreted as the hitting times of the guard.
The {\em final measure} in each mode $j$ can be defined as:
\begin{align}
  \mu_{f_j}=\delta_T\otimes \mu_{T_j}+\sum_{k\in\{l\mid (j,l)\in \mathcal E\}}\mu_{ G_{(j,k)}}.
\label{eq:mu_T}
\end{align}

% Given a set of initial conditions $X_{0}$, the dynamics of the system---under appropriate assumptions---defines a bundle of trajectories of the system states. It is of interest to ensure that this bundle terminates in the desired set $X_T$, making $X_0$ a subset of the BRS; stated differently, it is necessary to relate $\{\mu_{s_j}\}_{j\in \mathcal J}$ with $\{\mu_{f_j}\}_{j\in \mathcal J}$ and the dynamics of the system. 
To compute $X_0$, we relate $\{\mu_{s_j}\}_{j\in \mathcal J}$ with $\{\mu_{f_j}\}_{j\in \mathcal J}$ using the dynamics of the system.
As a first step, define linear operators {$\mathcal L_{ f_j}\colon \mathcal C^1(\mathcal T\times D_j\times \Theta_j)\rightarrow \mathcal C(\mathcal T\times D_j\times \Theta_j)$} as:
\begin{align}
      \mathcal L_{f_j}v=\frac{\partial v}{\partial t}+\ip{\nabla_x v,\tilde f_j}
    \label{eq:Lv}
\end{align}
where $v\in \mathcal C^1(\mathcal T\times D_j\times \Theta_j;\R)$ is an arbitrary test function and $\nabla_x v$ computes the gradient of $v$ in the $D_j$ coordinates.
Suppose the system transitioned to mode $j$ at \mbox{$t=\tau_{k-1}$} with the state taking value upon reset $x(\tau_{k-1})$ and $\theta$.
The value of $v$, evaluated along the flow of the system and at $t=\tau_{k}$ is computed using the Fundamental Theorem of Calculus:
\begin{align}
\begin{aligned}
    v& \big(\tau_k,x(\tau_{k}\mid x(\tau_{k-1}),\theta_{k-1})\big)=v(\tau_{k-1},x(\tau_{k-1}),\theta_{k-1})\\
    &+\int_{\tau_{k-1}}^{\tau_{k}}\hspace*{-2mm}\mathcal L_{f}v(t,x(t\mid \tau_{k-1},x(\tau_{k-1}),\theta_{k-1}))\,dt.
\end{aligned}
\label{eq:FTC}
\end{align}
Using Eqn.~(\ref{eq:mu_lambda}), Eqn.~(\ref{eq:FTC}) can be re-written as:
\small
\begin{align}
\begin{aligned}
    v\big(\tau_k,&x(\tau_{k}\mid \tau_{k-1},x(\tau_{k-1}),\theta_{k-1})\big)=v(\tau_{k-1},x(\tau_{k-1}),\theta_{k-1})\\
    &+\ip{\mu_j(\cdot\mid \tau_{k-1},x(\tau_{k-1},\theta_{k-1}),\mathcal L_{ f}v},
\end{aligned}
\end{align}
\normalsize
which can be simplified further by using Eqns.~(\ref{eq:mu_avg})--(\ref{eq:mu_T}):
\begin{align}
  \ip{\mu_{f_j},v}=\ip{\mu_{s_j},v}+\ip{\mu_{j},\mathcal L_{f}v}.
  \label{eq:liouville_1}
\end{align}

Alternatively, using the standard definition of adjoint operators\footnote{A linear operator $\mathcal L$ and its adjoint, $\mathcal L'$, satisfy the following relation:
\begin{align*}
    \ip{\mathcal L'\mu,v}=\ip{\mu,\mathcal Lv}.
\end{align*}
% \begin{align*}
%     \ip{\mathcal L'\mu,v}=\ip{\mu,\mathcal Lv}=\int\limits_{\mathcal X}\mathcal Lv\,d\mu.
% \end{align*}
}, Eqn.~(\ref{eq:liouville_1}) is re-written as:
\begin{align}
\ip{\mu_{f_j},v}=\ip{\mu_{s_j},v}+\ip{\mathcal L'_{f}\mu_{j},v}.
  \label{eq:liouville_2}
\end{align}
\emph{Eqn~(\ref{eq:liouville_2}) defines a linear relation that initial and final measures evolving according to the hybrid dynamics must satsify.}


During the execution of a hybrid system, any mode can be entered either at $t=0$ or due to reset.
The initial measure in the $(t,x)$-coordinate can be decomposed as:
\begin{align}
  \bar\mu_{0_j}=\delta_0\otimes\mu_{0_j}+\pi^{(t,x)}_*\sigma_{0_j}
\end{align}
where $\mu_{0_j}\in \mathcal M_+(D_j)$ is the measure describing initial conditions to the system at $t=0$, $\sigma_{0_j}\in \mathcal M_+(\mathcal T\times D_j\times \Theta_j)$ is a measure describing initial conditions arriving due to reset, and $\pi^{(t,x)}_*$ denotes the pushforward constructed by lifting the $(t,x)$-projection operator, $\pi^{(t,x)}: \mathcal T\times D_j\times \Theta_j \to \mathcal T\times D_j$, to measures (refer to Chapter 11 in \cite{lee2003smooth} for an introduction to pushforwards). 
State resets occur when the state reaches a guard. 
As a result, we must formalize a relationship between $\mu_{ G_{(i,j)}}$ and $\sigma_{0_j},~\forall (i,j)\in \mathcal E$.
To formalize this relationship notice that $\sigma_{0_j}$ can be decomposed into measures corresponding to the source of each arrival state:
\begin{align}
  \sigma_{0_j}=\sum_{i\in \{k\mid (k,j)\in \mathcal E\}} \sigma_{(i,j)}\otimes \mu_{\theta_j},
\end{align}
where $\sigma_{(i,j)}$ is the measure describing initial conditions that are reset into mode $j$ from guard $G_{(i,j)}$.
Upon reaching the guard, the system transitions according to the reset map, $R_{(i,j)}$, which can be treated as a nonlinear transformation between $D_i$ and $D_j$.
By applying a change of variables formula, as in Lemma 1 in \cite{shia2014convex}, we have:
\begin{align}
    \ip{\sigma_{(i,j)},w}=\ip{\pi^{(t,x)}_*\mu_{ G_{(i,j)}},w\circ R_{(i,j)}}
    \label{eq:reset_measure}
\end{align}
where $w\in \mathcal C(\mathcal T\times \mathcal D_j)$.
Note that since $\mu_{\theta_j}$ is a probability distribution, and there is no evolution along the $\Theta_j$ coordinate:
\begin{equation}
  \ip{\pi^{(t,x)}_*\mu_{ G_{(i,j)}},s}=\ip{\mu_{ G_{(i,j)}},s},
\end{equation}
for all $s\in \mathcal C(\mathcal T\times D_i)$. Essentially, $\sigma_{(i,j)}$ can be thought of as the push-forward measure of $\mu_{ G_{(i,j)}}$.
% essentially, $\sigma_{(i,j)}$ is a push-forward measure of $\mu_{ G_{(i,j)}}$.
%\begin{remark}
%\label{remark:primal}
%  \red{A note on domain in time and the Liouville's equations}
%\end{remark}

\subsection{The primal}
\label{ssec:primal}

The problem of computing the uncertain backwards reachable set of ${\cal H}$ can be formulated as an infinite-dimensional linear program that supremizes the \emph{volume} of the set of initial condition:
  \begin{flalign}\nonumber
  & & \sup_{\Lambda} \hspace*{1cm} & \sum_{j \in {\cal J}}\ip{\mu_{0_j},1} && (P) \nonumber \\
  & & \text{st.} \hspace*{1cm} &\mu_{s_j}+\mathcal L_{f}'\mu_j=\,\mu_{f_j } && \forall j\in {\cal J} \label{eq:primal:liouville}\\
  & & & \mu_{0_j}+\hat\mu_{0,j}=\,\lambda_j && \forall j\in {\cal J} \\
  & & & \sum_{j \in {\cal J}}\ip{\mu_{T_j},1}=\,\sum_{j \in {\cal J}}\ip{\mu_{0_j},1} && \label{eq:mass_conservation}
  \end{flalign}
where $\lambda_j$ is the Lebesgue measure supported on $D_j$, $\Lambda=\Big\{\big(\{\mu_j\}_{j \in {\cal J}},\{\mu_{0_j}\}_{j \in {\cal J}},\{\mu_{T_j}\}_{j \in {\cal J}},\{\hat\mu_{0,j}\}_{j \in {\cal J}},\{\mu_e\}_{e \in {\cal E}}\big) \in \bigtimes\limits_{j \in {\cal J}} {\cal M}_+({\cal T} \times D_j \times \Theta_j) \bigtimes\limits_{j \in {\cal J}} {\cal M}_+( D_j )  \bigtimes\limits_{j \in {\cal J}} {\cal M}_+( X_{(T,j)} )$ $\bigtimes\limits_{j \in {\cal J}} {\cal M}_+( D_j ) \bigtimes\limits_{e \in {\cal E}} {\cal M}_+( G_e )  \Big\}$, and $1$ denotes the function that takes value $1$ everywhere.
The $\hat\mu_{0_j}\in \mathcal M(D_j)$ are slack variables introduced to ensure that the mass of the $\mu_{0_j}$ are identical to the volume (under the Lebesgue measure) of the uncertain backwards reachable set, as we prove below. 
Eqn.~(\ref{eq:mass_conservation}) ensures that all trajectories that emanate $\cup_{j\in \mathcal J}\,supp(\mu_{0_j})$ reach $X_{T}$ at $t=T$.

\begin{lemma}
If $\{\mu_{0_j}\}_{j \in {\cal J}}$ are components of some $\mu \in \Lambda$ that optimizes $(P)$, then ${\cal X}_{(0,j)} = supp(\mu_{0_j})$ for each $j \in {\cal J}$.
In addition, the optimal value of $(P)$ is equal to the sum of \emph{volumes} of the uncertain backwards reachable set in each mode, i.e. $\sum_{j\in \mathcal J}\lambda_j(X_{0_j})$.
\end{lemma}
\begin{proof}
Suppose $\sum_{j\in \mathcal J}\lambda_j(supp(\mu_{0_j})\backslash X_{(0,j)})>0$, then by Lemma~\ref{lemma:existence} (in the appendix), there exist trajectories that begin in $\cup_{j\in \mathcal J}(supp(\mu_{0_j})\backslash X_{(0,j)})$ that reach $X_T$; this is a contradiction. Thus,
  \begin{align}
  &\bigcup_{j\in \mathcal J} supp(\mu_{0_j})\subset \bigcup_{j\in \mathcal J} X_{(0,j)},\\
  &\sum_{j\in \mathcal J}\lambda_j(supp(\mu_{0_j}))\le\sum_{j\in \mathcal J}\lambda_j( X_{(0,j)}).
  \label{eq:support_lemma:1}
  \end{align}
By definition of the BRS, all state trajectories that emanate from a subset of $X_0$ end in $X_T$. That is, for each $j\in \mathcal J$ and initial measure $\mu_{0_j}$, if $supp(\mu_{0_j})\subset X_{(0,j)}$, there exist measures $\mu_{j}$ and $\mu_{f_j}$ that satisfy Eqn.~(\ref{eq:primal:liouville}). 
Thus the following inequality is true:
    \begin{align}
    \sum_{j\in \mathcal J}\lambda_j(spt(\mu_{0_j}))\ge \sum_{j\in \mathcal J}\lambda_j(X_{(0,j)})
      \label{eq:support_lemma:2}
    \end{align}
From Eqns.~(\ref{eq:support_lemma:1}) and (\ref{eq:support_lemma:2}), $\cup_{j\in \mathcal J}\,spt(\mu_{0_j})$ is the BRS of the system. 
That the optimal value of $(P)$ is the volume of the uncertain backward reachable set follows by noting that the slack variables ensure absolute continuity of each $\mu_{0_j}$ with respect to the Lebesgue measure and the observation that \mbox{$\lambda_{j}|_{X_{(0,j)}},\forall j\in \mathcal J$} is feasible in ($P$).
  \end{proof}

\subsection{The dual}
\label{ssec:dual}
The dual to $(P)$ for a quasi-uncertain hybrid system ${\cal H}$ can be written as:
\begin{flalign}\nonumber
	& & \inf_F \hspace*{0.1cm} & \sum_{j\in {\cal J}}\ip{\lambda_j,w_j} && \hspace*{-0.1cm} (D)\nonumber\\
	& & \text{st.} \hspace*{0.1cm} & w_j(x)\ge \,0 && \hspace*{-0.1cm} \forall x \in D_j \nonumber \\
	& & & && \hspace*{-0.1cm} \forall j\in \mathcal J, \nonumber \\
	& & & v_j(T,x,\theta)+p\ge\, 0 ,\> && \hspace*{-0.1cm} \forall (x,\theta)\in \Phi_j \nonumber \\
	& & & && \hspace*{-0.1cm}\forall j \in {\cal J}, \label{eq:dual:terminal}\\
	& & & - \mathcal L_{f}v_j(t,x,\theta)\ge\,0 ,\> && \hspace*{-0.1cm} \forall (t,x,\theta)\in \Omega_j \nonumber \\
	& & & && \hspace*{-0.1cm}\forall j \in {\cal J}, \label{eq:dual:lfv} \\
	& & & w_j(x)-\ip{\mu_{\theta_j},v_j(0,x,\theta)}-p\ge \,1 ,\> && \hspace*{-0.1cm} \forall x \in D_j \nonumber\\
	& & & && \hspace*{-0.1cm}\forall j \in {\cal J}, \label{eq:dual:levelset} \\
	& & & v_j\ge\, \ip{\mu_{\theta_k},v_k}\circ R_{(j,k)},&& \hspace*{-0.1cm} \forall (x,\theta)\in \Upsilon_{(j,k)} \nonumber \\
	& & & && \hspace*{-0.1cm} \forall (j,k) \in {\cal E}, \label{eq:dual:mode_transition}
\end{flalign}
where $F = \Big\{ \big(\{v\}_{j \in {\cal J}},\{w_j\}_{j \in {\cal J}},p\big) \in \bigtimes\limits_{j \in {\cal J}}C^1(\mathcal T\times D_j\times \Theta_j) \bigtimes\limits_{j \in {\cal J}} C( D_j) \times \R \Big\}$, $\Phi_j = X_{(T,j)} \times \Theta_j $, $\Omega_j = {\cal T} \times D_j \times \Theta_j$, and $\Upsilon_{(j,k)}= G_{(j,k)} \times \Theta_j$. 
The solution to $D$ can be used to determine the uncertain backwards reachable set:
\begin{lemma}
If $\big(\{v\}_{j \in {\cal J}},\{w_j\}_{j \in {\cal J}},p\big)$ is a feasible point to $D$, then the super-level set:
\begin{align}
	\bigcup_{j\in \mathcal J}\,\{x \in D_j \mid w_j(x)\ge 1\}
\end{align}
is an outer approximation of the uncertain backwards reachable set of ${\cal H}$.
Furthermore there is a sequence of feasible solutions to $(D)$ such that for each $j \in {\cal J}$, the 1-super-level set of the feasible $w_j$ converges from above to the indicator function on $X_{(0,j)}$ in the $L^1$ norm and almost uniformly.
\end{lemma}

\begin{proof}
To prove this lemma we project the uncertain backwards reachable set into each mode and show that it is part of the 1-level set of $w$.
Assume that the state trajectory terminates in $X_{(T,j_k)}$ for some $j_k$
The state trajectory must have arrived in mode $j_k$ through a finite sequence of mode-transitions (according to Assumption~\ref{assump:zeno}). 
Let this sequences of mode-transitions be of length $k$. 
Suppose the states entered mode $j_k$ at time $\tau_k$, then from the Fundamental Theorem of Calculus and the constraints in Eqns.~(\ref{eq:dual:terminal})\&(\ref{eq:dual:lfv}), the following inequalities hold:
\begin{align}
	-q\le v_{j_k}(T,x(T\mid x(\tau_k^+),\theta),\theta)\le v_j(\tau_k,x(\tau_k^+),\theta)\\
	\Rightarrow -q\le \ip{\mu_{\theta_{j_k}},v_{j_k}(\tau_k,x(\tau_k^+),\theta)}
\end{align}
By iterative application of the constraint in Eqn.~(\ref{eq:dual:mode_transition}) and finally Eqn.~(\ref{eq:dual:levelset}), it follows that:
\begin{align}
	-q\le&\, \ip{\mu_{\theta_{j_k}},v_{j_k}(t,x,\theta)}\circ R_{(j_{k-1},j_{k})}(\tau_{k},x(\tau_{k}^-))\\
      \le&\, v_{j_{k-1}}(\tau_{k},x(\tau_{k}^-\mid x(\tau_{k-1}^+),\theta),\theta)\\
      \le &\, \ip{\mu_{\theta_{j_{k-1}}},v_{j_k}(\tau_k,x(\tau_{k-1}^+),\theta)}\\\nonumber
      &\,\vdots\\
      \le &\,v_{j_0}(\tau_1,x(\tau_1^-\mid x_0,\theta),\theta)\\
      \le &\,v_{j_0}(0,x_0,\theta)\\
      \le &\,\ip{\mu_{\theta_{j_0}},v_{j_0}(0,x_0,\theta)}\\
      \le &\, w_{j_0}(x_0)-q-1.
\end{align}
The final inequality implies that the initial condition of every trajectory that ends in the terminal set belongs to the 1-superlevel set of $w_j$ for some $j \in {\cal J}$.
The remainder of the proof follows from a straightforward extension to \cite[Theorem 2]{henrion2014convex}.
\end{proof}

Finally, note that the value computed by either optimization problem is equal which follows from \cite[Theorem 3.10]{Anderson1987} and is similar to \cite[Theorem 2]{henrion2014convex}:
\begin{lemma}
There is not gap between $(P)$ and $(D)$.
\end{lemma}

\begin{remark}
There are two key aspects of the presentation that deserve re-iteration: 
First, the uncertainties that influence the dynamics are drawn from the distribution each time a trajectory enters a new mode; 
Second, the uncertain backwards reachable set corresponds to the set of initial conditions for \emph{all} trajectories that are able to reach the terminal set in spite of \emph{all} possible sequences of ``discrete'' uncertainty that each have non-zero probability.
Notice that the uncertain backwards reachable set is the intersection of the backwards reachable set for ever possible discrete uncertainty with non-zero probability.
\end{remark}
